<!DOCTYPE html>

<html class="light" lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>TaskManager Admin Portal</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
    rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&amp;display=swap"
    rel="stylesheet" />
  <link
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
    rel="stylesheet" />
  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#137fec",
            "background-light": "#f6f7f8",
            "background-dark": "#101922",
          },
          fontFamily: {
            "display": ["Inter"]
          },
          borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
        },
      },
    }
  </script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
  </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-[#111418] dark:text-gray-100 font-display min-h-screen">
  <div class="flex flex-col min-h-screen">
    <!-- Top Navigation Bar -->
    <header
      class="flex items-center justify-between whitespace-nowrap border-b border-solid border-[#dbe0e6] dark:border-gray-800 bg-white dark:bg-[#1a242f] px-6 md:px-10 py-3">
      <div class="flex items-center gap-4 text-primary">
        <div class="size-8">
          <svg fill="none" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
            <path clip-rule="evenodd"
              d="M24 18.4228L42 11.475V34.3663C42 34.7796 41.7457 35.1504 41.3601 35.2992L24 42V18.4228Z"
              fill="currentColor" fill-rule="evenodd"></path>
            <path clip-rule="evenodd"
              d="M24 8.18819L33.4123 11.574L24 15.2071L14.5877 11.574L24 8.18819ZM9 15.8487L21 20.4805V37.6263L9 32.9945V15.8487ZM27 37.6263V20.4805L39 15.8487V32.9945L27 37.6263ZM25.354 2.29885C24.4788 1.98402 23.5212 1.98402 22.646 2.29885L4.98454 8.65208C3.7939 9.08038 3 10.2097 3 11.475V34.3663C3 36.0196 4.01719 37.5026 5.55962 38.098L22.9197 44.7987C23.6149 45.0671 24.3851 45.0671 25.0803 44.7987L42.4404 38.098C43.9828 37.5026 45 36.0196 45 34.3663V11.475C45 10.2097 44.2061 9.08038 43.0155 8.65208L25.354 2.29885Z"
              fill="currentColor" fill-rule="evenodd"></path>
          </svg>
        </div>
        <h2 class="text-[#111418] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">TaskManager |
          Admin Portal</h2>
      </div>
      <div class="flex flex-1 justify-end gap-4 items-center">
        <button
          class="flex items-center justify-center p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full">
          <span class="material-symbols-outlined">notifications</span>
        </button>
        <div
          class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 border border-gray-200 dark:border-gray-700"
          data-alt="Admin user profile picture"
          style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuDMZLd2AFinpbzDf0gZHS0JnPbjUcUDbZpso7OIXaDNTrQCGrCstZmwJQyAd5hhQs8UdYsFvu0Znm0iRyEMsNouSQyD2sNjwyO5ejgUjtb_C653h5RsV8pT_FsukfxtpnAfai8jmKGR09BDAvH6lUdPJVQb57ufDLCIak8D9QGDnnlRXEWJvjcklELvsoOk82_XPyU3DPIJ18FzrMGpi2gXnfFXK5cb9gHN6YoMgYOV5tXOpEstmCvDjZEMiQEv90KdDKFFdn_6xrI");'>
        </div>
      </div>
    </header>
    <main class="flex-1 px-4 md:px-10 lg:px-20 py-8">
      <!-- Hero section -->
      <div class="mb-8">
        <h1 class="text-[#111418] dark:text-white text-4xl font-black leading-tight tracking-[-0.033em]">Admin Dashboard
        </h1>
        <p class="text-[#617589] dark:text-gray-400 text-base font-normal leading-normal">Manage your team and tasks
          from a central location.</p>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
        <!-- Column 1: Create User -->
        <section
          class="bg-white dark:bg-[#1a242f] p-6 md:p-8 rounded-xl border border-[#dbe0e6] dark:border-gray-800 shadow-sm">
          <div class="flex items-center gap-3 mb-6">
            <span class="material-symbols-outlined text-primary">person_add</span>
            <h3 class="text-[#111418] dark:text-white text-2xl font-bold leading-tight">Register New User</h3>
          </div>
          <form class="space-y-5">
            <div class="flex flex-col gap-2">
              <label class="text-[#111418] dark:text-gray-200 text-sm font-semibold">User Name</label>
              <input
                class="form-input flex w-full rounded-lg text-[#111418] dark:text-white border-[#dbe0e6] dark:border-gray-700 bg-white dark:bg-[#101922] focus:ring-2 focus:ring-primary focus:border-primary h-12 placeholder:text-[#617589] p-4"
                placeholder="Enter full name" type="text" />
            </div>
            <div class="flex flex-col gap-2">
              <label class="text-[#111418] dark:text-gray-200 text-sm font-semibold">Email Address</label>
              <input
                class="form-input flex w-full rounded-lg text-[#111418] dark:text-white border-[#dbe0e6] dark:border-gray-700 bg-white dark:bg-[#101922] focus:ring-2 focus:ring-primary focus:border-primary h-12 placeholder:text-[#617589] p-4"
                placeholder="email@example.com" type="email" />
            </div>
            <div class="flex flex-col gap-2">
              <label class="text-[#111418] dark:text-gray-200 text-sm font-semibold">Set Password</label>
              <div class="relative">
                <input
                  class="form-input flex w-full rounded-lg text-[#111418] dark:text-white border-[#dbe0e6] dark:border-gray-700 bg-white dark:bg-[#101922] focus:ring-2 focus:ring-primary focus:border-primary h-12 placeholder:text-[#617589] p-4 pr-12"
                  placeholder="••••••••" type="password" />
                <span
                  class="material-symbols-outlined absolute right-4 top-3 text-[#617589] cursor-pointer">visibility</span>
              </div>
            </div>
            <div class="flex gap-2 p-4 bg-primary/5 dark:bg-primary/10 rounded-lg border border-primary/20">
              <span class="material-symbols-outlined text-primary text-xl">info</span>
              <p class="text-sm text-[#111418] dark:text-gray-300">Credentials will be sent to the user's email address
                automatically.</p>
            </div>
            <button
              class="w-full bg-primary text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-600 transition-colors duration-200 shadow-sm"
              type="submit">
              Create User
            </button>
          </form>
        </section>
        <!-- Column 2: Create Task -->
        <section
          class="bg-white dark:bg-[#1a242f] p-6 md:p-8 rounded-xl border border-[#dbe0e6] dark:border-gray-800 shadow-sm">
          <div class="flex items-center gap-3 mb-6">
            <span class="material-symbols-outlined text-primary">add_task</span>
            <h3 class="text-[#111418] dark:text-white text-2xl font-bold leading-tight">Assign New Task</h3>
          </div>
          <form class="space-y-5">
            <div class="flex flex-col gap-2">
              <label class="text-[#111418] dark:text-gray-200 text-sm font-semibold">Task Title</label>
              <input
                class="form-input flex w-full rounded-lg text-[#111418] dark:text-white border-[#dbe0e6] dark:border-gray-700 bg-white dark:bg-[#101922] focus:ring-2 focus:ring-primary focus:border-primary h-12 placeholder:text-[#617589] p-4"
                placeholder="e.g. Design Landing Page" type="text" />
            </div>
            <div class="flex flex-col gap-2">
              <label class="text-[#111418] dark:text-gray-200 text-sm font-semibold">Description</label>
              <textarea
                class="form-textarea flex w-full rounded-lg text-[#111418] dark:text-white border-[#dbe0e6] dark:border-gray-700 bg-white dark:bg-[#101922] focus:ring-2 focus:ring-primary focus:border-primary min-h-[100px] placeholder:text-[#617589] p-4 resize-none"
                placeholder="Provide detailed task requirements..."></textarea>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="flex flex-col gap-2">
                <label class="text-[#111418] dark:text-gray-200 text-sm font-semibold">Assign to User</label>
                <div class="relative">
                  <select
                    class="form-select flex w-full rounded-lg text-[#111418] dark:text-white border-[#dbe0e6] dark:border-gray-700 bg-white dark:bg-[#101922] focus:ring-2 focus:ring-primary focus:border-primary h-12 p-2 px-4 appearance-none">
                    <option disabled="" selected="" value="">Select user</option>
                    <option value="1">John Doe</option>
                    <option value="2">Jane Smith</option>
                    <option value="3">Alex Rivera</option>
                    <option value="4">Sarah Chen</option>
                  </select>
                  <span
                    class="material-symbols-outlined absolute right-4 top-3 pointer-events-none text-gray-500">expand_more</span>
                </div>
              </div>
              <div class="flex flex-col gap-2">
                <label class="text-[#111418] dark:text-gray-200 text-sm font-semibold">Due Date</label>
                <div class="relative">
                  <input
                    class="form-input flex w-full rounded-lg text-[#111418] dark:text-white border-[#dbe0e6] dark:border-gray-700 bg-white dark:bg-[#101922] focus:ring-2 focus:ring-primary focus:border-primary h-12 p-4"
                    type="date" />
                </div>
              </div>
            </div>
            <div class="flex flex-col gap-2">
              <label class="text-[#111418] dark:text-gray-200 text-sm font-semibold">Priority</label>
              <div class="grid grid-cols-4 gap-2">
                <label class="priority-option flex items-center justify-center gap-2 p-3 rounded-lg border-2 border-[#dbe0e6] dark:border-gray-700 cursor-pointer hover:border-blue-400 transition-colors has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/20">
                  <input type="radio" name="priority" value="low" class="hidden" />
                  <span class="material-symbols-outlined text-blue-500 text-lg">arrow_downward</span>
                  <span class="text-sm font-semibold">Low</span>
                </label>
                <label class="priority-option flex items-center justify-center gap-2 p-3 rounded-lg border-2 border-[#dbe0e6] dark:border-gray-700 cursor-pointer hover:border-amber-400 transition-colors has-[:checked]:border-amber-500 has-[:checked]:bg-amber-50 dark:has-[:checked]:bg-amber-900/20">
                  <input type="radio" name="priority" value="medium" class="hidden" checked />
                  <span class="material-symbols-outlined text-amber-500 text-lg">remove</span>
                  <span class="text-sm font-semibold">Medium</span>
                </label>
                <label class="priority-option flex items-center justify-center gap-2 p-3 rounded-lg border-2 border-[#dbe0e6] dark:border-gray-700 cursor-pointer hover:border-orange-400 transition-colors has-[:checked]:border-orange-500 has-[:checked]:bg-orange-50 dark:has-[:checked]:bg-orange-900/20">
                  <input type="radio" name="priority" value="high" class="hidden" />
                  <span class="material-symbols-outlined text-orange-500 text-lg">arrow_upward</span>
                  <span class="text-sm font-semibold">High</span>
                </label>
                <label class="priority-option flex items-center justify-center gap-2 p-3 rounded-lg border-2 border-[#dbe0e6] dark:border-gray-700 cursor-pointer hover:border-red-400 transition-colors has-[:checked]:border-red-500 has-[:checked]:bg-red-50 dark:has-[:checked]:bg-red-900/20">
                  <input type="radio" name="priority" value="urgent" class="hidden" />
                  <span class="material-symbols-outlined text-red-500 text-lg">priority_high</span>
                  <span class="text-sm font-semibold">Urgent</span>
                </label>
              </div>
            </div>
            <button
              class="w-full bg-primary text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-600 transition-colors duration-200 shadow-sm mt-4"
              type="submit">
              Assign Task
            </button>
          </form>
        </section>
      </div>
      <!-- Dashboard Stats Summary -->
      <div class="mt-12 grid grid-cols-1 md:grid-cols-3 gap-6">
        <a href="../total_users_management/code.html"
          class="bg-white dark:bg-[#1a242f] p-6 rounded-xl border border-[#dbe0e6] dark:border-gray-800 flex items-center gap-4 hover:border-primary transition-colors">
          <div class="bg-blue-100 dark:bg-blue-900/30 p-3 rounded-lg text-primary">
            <span class="material-symbols-outlined text-3xl">groups</span>
          </div>
          <div>
            <p class="text-[#617589] dark:text-gray-400 text-sm">Total Users</p>
            <p id="stat-total-users" class="text-2xl font-bold dark:text-white">--</p>
          </div>
        </a>
        <a href="../completed_tasks_overview/code.html"
          class="bg-white dark:bg-[#1a242f] p-6 rounded-xl border border-[#dbe0e6] dark:border-gray-800 flex items-center gap-4 hover:border-primary transition-colors">
          <div class="bg-green-100 dark:bg-green-900/30 p-3 rounded-lg text-green-600">
            <span class="material-symbols-outlined text-3xl">check_circle</span>
          </div>
          <div>
            <p class="text-[#617589] dark:text-gray-400 text-sm">Completed Tasks</p>
            <p id="stat-completed-tasks" class="text-2xl font-bold dark:text-white">--</p>
          </div>
        </a>
        <a href="../active_tasks_monitoring/code.html"
          class="bg-white dark:bg-[#1a242f] p-6 rounded-xl border border-[#dbe0e6] dark:border-gray-800 flex items-center gap-4 hover:border-primary transition-colors">
          <div class="bg-orange-100 dark:bg-orange-900/30 p-3 rounded-lg text-orange-600">
            <span class="material-symbols-outlined text-3xl">pending_actions</span>
          </div>
          <div>
            <p class="text-[#617589] dark:text-gray-400 text-sm">Active Tasks</p>
            <p id="stat-active-tasks" class="text-2xl font-bold dark:text-white">--</p>
          </div>
        </a>
      </div>
    </main>
    <footer class="mt-auto px-10 py-6 border-t border-[#dbe0e6] dark:border-gray-800 bg-white dark:bg-[#1a242f]">
      <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <p class="text-[#617589] dark:text-gray-400 text-sm font-normal">© 2024 TaskManager Admin Portal. All rights
          reserved.</p>
        <div class="flex gap-6">
          <a class="text-[#617589] dark:text-gray-400 text-sm hover:text-primary transition-colors" href="#">Support</a>
          <a class="text-[#617589] dark:text-gray-400 text-sm hover:text-primary transition-colors" href="#">Privacy
            Policy</a>
          <a class="text-[#617589] dark:text-gray-400 text-sm hover:text-primary transition-colors"
            href="#">Documentation</a>
        </div>
      </div>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // 1. Check Authentication and Authorization
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user'));

      if (!token || !user || user.role !== 'admin') {
        alert('Access Denied. Please login as an administrator.');
        window.location.href = '../taskmanager_login_screen/code.html';
        return;
      }

      // 2. Update UI with User Info
      const adminNameHeader = document.querySelector('h2');
      if (adminNameHeader && user.fullname) {
        adminNameHeader.textContent = `TaskManager | Admin: ${user.fullname}`;
      }

      // 3. Setup Logout
      const profilePic = document.querySelector('[data-alt="Admin user profile picture"]');
      if (profilePic) {
        profilePic.style.cursor = 'pointer';
        profilePic.title = 'Click to Logout';
        profilePic.addEventListener('click', () => {
          if (confirm('Are you sure you want to logout?')) {
            localStorage.clear();
            window.location.href = '../taskmanager_login_screen/code.html';
          }
        });
      }

      // 4. Handle Registration Form Submission
      const registerForm = document.querySelector('section:first-of-type form');
      if (registerForm) {
        registerForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const inputs = registerForm.querySelectorAll('input');
          const fullname = inputs[0].value;
          const email = inputs[1].value;
          const password = inputs[2].value;
          const submitBtn = registerForm.querySelector('button');

          try {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Registering...';

            const response = await fetch('https://taskmanager-mszs.onrender.com/auth/register', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({ fullname, email, password })
            });

            const data = await response.json();

            if (response.ok) {
              alert('User registered successfully!');
              registerForm.reset();
              loadUsers(); // Refresh user dropdown
            } else {
              alert(data.detail || 'Registration failed.');
            }
          } catch (error) {
            console.error('Error:', error);
            alert('Failed to connect to backend.');
          } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Create User';
          }
        });
      }

      // 5. Load users for task assignment dropdown
      loadUsers();

      // 6. Load dashboard stats
      loadDashboardStats();

      // 7. Handle Task Assignment Form
      const taskForm = document.querySelector('section:nth-of-type(2) form');
      if (taskForm) {
        taskForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const title = taskForm.querySelector('input[type="text"]').value;
          const description = taskForm.querySelector('textarea').value;
          const assignedTo = taskForm.querySelector('select').value;
          const dueDate = taskForm.querySelector('input[type="date"]').value;
          const priority = taskForm.querySelector('input[name="priority"]:checked')?.value || 'medium';
          const submitBtn = taskForm.querySelector('button[type="submit"]');

          if (!assignedTo) {
            alert('Please select a user to assign the task.');
            return;
          }

          if (!dueDate) {
            alert('Please select a due date.');
            return;
          }

          try {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Assigning...';

            const response = await fetch('https://taskmanager-mszs.onrender.com/tasks/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({
                title,
                description,
                assigned_to: assignedTo,
                due_date: dueDate,
                status: 'pending',
                priority
              })
            });

            const data = await response.json();

            if (response.ok) {
              alert('Task assigned successfully!');
              taskForm.reset();
              // Reset priority to medium (default)
              taskForm.querySelector('input[name="priority"][value="medium"]').checked = true;
              // Refresh dashboard stats
              loadDashboardStats();
            } else {
              alert(data.detail || 'Failed to assign task.');
            }
          } catch (error) {
            console.error('Error:', error);
            alert('Failed to connect to backend.');
          } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Assign Task';
          }
        });
      }
    });

    async function loadUsers() {
      const token = localStorage.getItem('token');
      const userSelect = document.querySelector('section:nth-of-type(2) select');
      
      try {
        const response = await fetch('https://taskmanager-mszs.onrender.com/auth/users', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const users = await response.json();
          userSelect.innerHTML = '<option disabled selected value="">Select user</option>';
          users.forEach(user => {
            if (user.role !== 'admin') {
              userSelect.innerHTML += `<option value="${user.id}">${user.fullname} (${user.email})</option>`;
            }
          });
        }
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    async function loadDashboardStats() {
      const token = localStorage.getItem('token');
      
      try {
        const response = await fetch('https://taskmanager-mszs.onrender.com/tasks/stats', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const stats = await response.json();
          document.getElementById('stat-total-users').textContent = stats.total_users;
          document.getElementById('stat-completed-tasks').textContent = stats.completed_tasks;
          document.getElementById('stat-active-tasks').textContent = stats.active_tasks;
        } else {
          console.error('Failed to load stats');
        }
      } catch (error) {
        console.error('Error loading dashboard stats:', error);
      }
    }
  </script>
</body>

</html>